PRO hadgem3_monwg_isv_metrics_box_whisker_captivate_final

trmm_n96_1030_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n96/TRMM_3B42v6A.jan-dec_dmeans.1999-2010.anom_filter_1030.n96.nc'
trmm_n96_3050_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n96/TRMM_3B42v6A.jan-dec_dmeans.1999-2010.anom_filter_3050.n96.nc'
trmm_n96_2120_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n96/TRMM_3B42v6A.jan-dec_dmeans.1999-2010.anom_filter_2120.n96.nc'
trmm_n96_clim_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n96/TRMM_3B42v6A.jan-dec_dmeans_clim.1999-2010.n96.nc'

trmm_n216_1030_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n216/TRMM_3B42v6A.jan-dec_dmeans.1999-2010.anom_filter_1030.n216.nc'
trmm_n216_3050_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n216/TRMM_3B42v6A.jan-dec_dmeans.1999-2010.anom_filter_3050.n216.nc'
trmm_n216_clim_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n216/TRMM_3B42v6A.jan-dec_dmeans_clim.1999-2010.anom_filter_3050.n216.nc'

; HadGEM3-A N96L85 MORPH3 final assessment
airxv_1030_file='/home/ss901165/um_output3/hadgem3_monwg/airxv/hadgem3a_morph3_final_n96_amip2_airxv.jan-dec_dmeans_anom_filter1020.1982-2008.precip.nc'
airxv_3050_file='/home/ss901165/um_output3/hadgem3_monwg/airxv/hadgem3a_morph3_final_n96_amip2_airxv.jan-dec_dmeans_anom_filter3050.1982-2008.precip.nc'
airxv_2120_file='/home/ss901165/um_output3/hadgem3_monwg/airxv/hadgem3a_morph3_final_n96_amip2_airxv.jan-dec_dmeans_anom_filter2120.1982-2008.precip.nc'
airxv_clim_file='/home/ss901165/um_output3/hadgem3_monwg/airxv/hadgem3a_morph3_final_n96_amip2_airxv.jan-dec_dmeans_clim.1982-2008.precip.nc'

; HadGEM3-AO N96L85 ORCA1 MORPH3 final assessment
aicvx_1030_file='/home/ss901165/um_output3/hadgem3_monwg/aicvx/hadgem3ao_morph3_final_n96_orca1_aicvx.jan-dec_dmeans_anom_filter1020.years1-30.precip.nc'
aicvx_3050_file='/home/ss901165/um_output3/hadgem3_monwg/aicvx/hadgem3ao_morph3_final_n96_orca1_aicvx.jan-dec_dmeans_anom_filter3050.years1-30.precip.nc'
aicvx_2120_file='/home/ss901165/um_output3/hadgem3_monwg/aicvx/hadgem3ao_morph3_final_n96_orca1_aicvx.jan-dec_dmeans_anom_filter2120.years1-30.precip.nc'
aicvx_clim_file='/home/ss901165/um_output3/hadgem3_monwg/aicvx/hadgem3ao_morph3_final_n96_orca1_aicvx.jan-dec_dmeans_clim.years1-30.precip.nc'

; HadGEM2-AO control for comparison against CAPTIVATE runs
ajpdr_1030_file='/home/ss901165/um_output3/hadgem3_monwg/ajpdr/hadgem2ao_final_n96_pdctl_ajpdr.jan-dec_dmeans.2029-2078.anom_filter_1030.precip.nc'
ajpdr_3050_file='/home/ss901165/um_output3/hadgem3_monwg/ajpdr/hadgem2ao_final_n96_pdctl_ajpdr.jan-dec_dmeans.2029-2078.anom_filter_3050.precip.nc'
ajpdr_2120_file='/home/ss901165/um_output3/hadgem3_monwg/ajpdr/hadgem2ao_final_n96_pdctl_ajpdr.jan-dec_dmeans.2029-2078.anom_filter_2120.precip.nc'
ajpdr_clim_file='/home/ss901165/um_output3/hadgem3_monwg/ajpdr/hadgem2ao_final_n96_pdctl_ajpdr.jan-dec_dmean_clim.2029-2078.precip.nc'

; HadGEM3-AO Captivate final assessment (N96)
ajtzr_1030_file='/home/ss901165/um_output3/hadgem3_monwg/ajtzr/hadgem3ao_captivate_n96_orca1_ajtzr.jan-dec_dmeans.1979-2008.anom_filter_1030.precip.nc'
ajtzr_3050_file='/home/ss901165/um_output3/hadgem3_monwg/ajtzr/hadgem3ao_captivate_n96_orca1_ajtzr.jan-dec_dmeans.1979-2008.anom_filter_3050.precip.nc'
ajtzr_2120_file='/home/ss901165/um_output3/hadgem3_monwg/ajtzr/hadgem3ao_captivate_n96_orca1_ajtzr.jan-dec_dmeans.1979-2008.anom_filter_2120.precip.nc'
ajtzr_clim_file='/home/ss901165/um_output3/hadgem3_monwg/ajtzr/hadgem3ao_captivate_n96_orca1_ajtzr.jan-dec_dmean_clim.1979-2008.precip.nc'

; HadGEM3-AO Captivate final assessment (N216)
xfhhk_1030_file='/home/ss901165/um_output3/hadgem3_monwg/xfhhk/hadgem3hao_captivate_n216_orca025_xfhhk.jan-dec_dmeans.1980-2059.anom_filter_1030.precip.nc'
xfhhk_3050_file='/home/ss901165/um_output3/hadgem3_monwg/xfhhk/hadgem3hao_captivate_n216_orca025_xfhhk.jan-dec_dmeans.1980-2059.anom_filter_3050.precip.nc'
xfhhk_2120_file='/home/ss901165/um_output3/hadgem3_monwg/xfhhk/hadgem3hao_captivate_n216_orca025_xfhhk.jan-dec_dmeans.1980-2059.anom_filter_2120.precip.nc'
xfhhk_clim_file='/home/ss901165/um_output3/hadgem3_monwg/xfhhk/hadgem3hao_captivate_n216_orca025_xfhhk.jan-dec_dmean_clim.1980-2059.precip.nc'

; HadGEM3-A AMIP2 clim SST w/ 1.0x entrain
nickctl_1030_file='/home/ss901165/um_output3/hadgem3a_amip2_control_vn74/hadgem3a_amip2_ctl_vn74.jan-dec_dmeans.years1-30.anom_filter_1030.precip.nc'
nickctl_3050_file='/home/ss901165/um_output3/hadgem3a_amip2_control_vn74/hadgem3a_amip2_ctl_vn74.jan-dec_dmeans.years1-30.anom_filter_3050.precip.nc'
nickctl_2120_file='/home/ss901165/um_output3/hadgem3a_amip2_control_vn74/hadgem3a_amip2_ctl_vn74.jan-dec_dmeans.years1-30.anom_filter_2120.precip.nc'
nickctl_clim_file='/home/ss901165/um_output3/hadgem3a_amip2_control_vn74/hadgem3a_amip2_ctl_vn74.jan-dec_dmean_clim.years1-30.precip.nc'

; HadGEM3-A AMIP2 clim SST w/ 1.5x entrain
nickentrain_1030_file='/home/ss901165/um_output3/hadgem3a_amip2_1.5xentrain_vn74/hadgem3a_amip2_1.5xentrain_vn74.jan-dec_dmeans.years1-30.anom_filter_1030.precip.nc'
nickentrain_3050_file='/home/ss901165/um_output3/hadgem3a_amip2_1.5xentrain_vn74/hadgem3a_amip2_1.5xentrain_vn74.jan-dec_dmeans.years1-30.anom_filter_3050.precip.nc'
nickentrain_2120_file='/home/ss901165/um_output3/hadgem3a_amip2_1.5xentrain_vn74/hadgem3a_amip2_1.5xentrain_vn74.jan-dec_dmeans.years1-30.anom_filter_2120.precip.nc'
nickentrain_clim_file='/home/ss901165/um_output3/hadgem3a_amip2_1.5xentrain_vn74/hadgem3a_amip2_1.5xentrain_vn74.jan-dec_dmean_clim.years1-30.precip.nc'

n_metrics=7
boxes_metrics=fltarr(n_metrics,4)
boxes_metrics(0,*)=[-5,70,10,100]
boxes_metrics(1,*)=[10,80,25,100]
boxes_metrics(2,*)=[10,115,20,145]
boxes_metrics(3,*)=[10,80,25,100]
boxes_metrics(4,*)=[-10,50,30,150]
boxes_metrics(5,*)=[-10,50,30,150]
boxes_metrics(6,*)=[-10,50,30,150]
metric_names=['EEqIO','BoB','NWPac','BoB','MonDom']
titles=['30-50 day variability in the Eastern Equatorial Indian Ocean (5S-10N, 70-100E)',$
        '30-50 day variability in the Bay of Bengal (10-25N, 80-100E)',$
        '10-20 day variability in the NW Tropical Pacific (10-20N, 115-145E)',$
        '10-20 day variability in the Bay of Bengal (10-25N, 80-100E)',$
        '30-50 day variability across the domain (10S-30N, 50-150E)',$
        '10-20 day variability across the domain (10S-30N, 50-150E)',$
        '2-120 day variability across the domain (10S-30N, 50-150E)']

n_sets=4
max_years=50

width=10
xlocation=0.5
missing=-9999

metrics=fltarr(n_metrics*n_sets,max_years)
metrics_scaled=fltarr(n_metrics*n_sets,max_years)
metrics_obs=fltarr(n_metrics,max_years)
metrics_norm_obs=fltarr(n_metrics*n_sets,max_years)
xlabels=strarr(n_metrics*n_sets)
colors=intarr(n_sets)

black=FSC_COLOR("black",2)
red=FSC_COLOR("red",3)
blue=FSC_COLOR("blue",4)
cyan=FSC_COLOR("cyan",5)
purple=FSC_COLOR("purple",6)
brown=FSC_COLOR("brown",7)
orange=FSC_COLOR("orange",8)

;legend_items=['HadGEM2 (for comparison)','Captivate assess N96','Captivate assess N216',$
;              'MORPH3 assess N96','HadGEM3-A Nick 1.0x ent (ctl)','HadGEM3-A Nick 1.5x ent']
;legend_colors=[3,4,5,6,7,8]
legend_items=['TRMM at N96 (obs)','HadGEM2 (for comparison)','Captivate assess N96','Captivate assess N216']
legend_colors=[2,3,4,5]

FOR i=0,n_sets-1 DO BEGIN
   print,'--> '+STRTRIM(STRING(i),1)
   CASE i OF
      0: BEGIN
         metrics_infiles=[trmm_n96_3050_file,trmm_n96_3050_file,trmm_n96_1030_file,trmm_n96_1030_file,$
                          trmm_n96_3050_file,trmm_n96_1030_file,trmm_n96_2120_file]
         clim_infile=trmm_n96_clim_file
         clim_start_read=151
         clim_fourd=0
         start_read=[151,151,151,151,151,151,151]
         plot_title='TRMM N96 (99-10)'  
         n_days=122
         n_years=12
         multiplier=1    
         variable='precip'
         obs_nyears=n_years
         year_dimension_last=0
         color=2
      END
      1: BEGIN
         metrics_infiles=[ajpdr_3050_file,ajpdr_3050_file,ajpdr_1030_file,ajpdr_1030_file,$
                          ajpdr_3050_file,ajpdr_1030_file,ajpdr_2120_file]
         clim_infile=ajpdr_clim_file
         clim_start_read=150
         clim_fourd=0
         start_read=[150,150,150,150,150,150,150]
         plot_title='HG2 ajpdr'
         n_days=120
         n_years=49
         multiplier=86400.
         variable='precip'
         year_dimension_last=0
         color=3
      END         
      2 : BEGIN
         metrics_infiles=[ajtzr_3050_file,ajtzr_3050_file,ajtzr_1030_file,ajtzr_1030_file,$
                          ajtzr_3050_file,ajtzr_1030_file,ajtzr_2120_file]
         clim_infile=ajtzr_clim_file
         clim_start_read=150
         clim_fourd=0
         start_read=[150,150,150,150,150,150,150]
         plot_title='HG3 ajtzr'
         n_days=120
         n_years=29
         multiplier=86400.
         variable='precip'
         year_dimension_last=0
         color=4
      END
      3 : BEGIN
         metrics_infiles=[xfhhk_3050_file,xfhhk_3050_file,xfhhk_1030_file,xfhhk_1030_file,$
                          xfhhk_3050_file,xfhhk_1030_file,xfhhk_2120_file]
         clim_infile=xfhhk_clim_file
         clim_start_read=150
         clim_fourd=0
         start_read=[150,150,150,150,150,150,150]
         plot_title='HG3 xfhhk'
         n_days=120
         n_years=29
         multiplier=86400.
         variable='precip'
         year_dimension_last=1
         color=5
      END
      4 : BEGIN
         metrics_infiles=[aicvx_3050_file,aicvx_3050_file,aicvx_1030_file,aicvx_1030_file,$
                          aicvx_3050_file,aicvx_1030_file,aicvx_2120_file]
         clim_infile=aicvx_clim_file
         clim_start_read=150
         clim_fourd=0
         start_read=[150,150,150,150,150,150,150]
         plot_title='HG3 aicvx'
         n_days=120
         n_years=29
         multiplier=86400.
         variable='precip'
         year_dimension_last=1
         color=6
      END
       5 : BEGIN
         metrics_infiles=[nickctl_3050_file,nickctl_3050_file,nickctl_1030_file,nickctl_1030_file,$
                          nickctl_3050_file,nickctl_1030_file,nickctl_2120_file]
         clim_infile=nickctl_clim_file
         clim_start_read=150
         clim_fourd=0
         start_read=[150,150,150,150,150,150,150]
         plot_title='HG3 Nick ctl'
         n_days=120
         n_years=29
         multiplier=86400.
         variable='precip'
         year_dimension_last=0
         color=7
      END      
       6 : BEGIN
          metrics_infiles=[nickentrain_3050_file,nickentrain_3050_file,nickentrain_1030_file,nickentrain_1030_file,$
                           nickentrain_3050_file,nickentrain_1030_file,nickentrain_2120_file]
          clim_infile=nickentrain_clim_file
          clim_start_read=150
          clim_fourd=0
          start_read=[150,150,150,150,150,150,150]
          plot_title='HG3 Nick 1.5xent'
          n_days=120
          n_years=29
          multiplier=86400.
          variable='precip'
          year_dimension_last=0
          color=8
       END      
   ENDCASE
   
   colors(i)=color
   FOR k=0,n_metrics-1 DO BEGIN
      print,'-----> '+STRTRIM(STRING(k),1)
      longitude=OPEN_AND_EXTRACT(metrics_infiles(k),'longitude')
      latitude=OPEN_AND_EXTRACT(metrics_infiles(k),'latitude')
      DEFINE_BOUNDARIES,REFORM(boxes_metrics(k,*)),latitude,longitude,box_tx,/LIMIT
      n_lon=N_ELEMENTS(longitude)
      n_lat=N_ELEMENTS(latitude)
      
      clim_longitude=OPEN_AND_EXTRACT(clim_infile,'longitude')
      clim_latitude=OPEN_AND_EXTRACT(clim_infile,'latitude')
      DEFINE_BOUNDARIES,REFORM(boxes_metrics(k,*)),clim_latitude,clim_longitude,clim_box_tx,/LIMIT
      clim_nlon=N_ELEMENTS(longitude)
      clim_nlat=N_ELEMENTS(latitude)
      clim_ndays=n_days
      
      IF clim_fourd eq 1 THEN BEGIN
         clim_precip=REFORM(OPEN_AND_EXTRACT(clim_infile,variable,$
                                             offset=[clim_box_tx(1),clim_box_tx(0),0,clim_start_read],$
                                             count=[clim_nlon,clim_nlat,1,clim_ndays]))*multiplier
      ENDIF ELSE BEGIN
         clim_precip=REFORM(OPEN_AND_EXTRACT(clim_infile,variable,$
                                             offset=[clim_box_tx(1),clim_box_tx(0),clim_start_read],$
                                             count=[clim_nlon,clim_nlat,clim_ndays]))*multiplier
      ENDELSE
      IF TOTAL(where(clim_precip ge 1E20)) gt 0 THEN $
         clim_precip[where(clim_precip ge 1E20)]=!Values.F_NaN
      
      clim_precip_aavg_seasmean=MEAN(clim_precip(*,*,*),/NaN)
      
      allyears_precip_filtered=fltarr(n_lon,n_lat,n_days*n_years)
      FOR j=0,n_years-1 DO BEGIN
         IF year_dimension_last eq 1 THEN BEGIN
            thisyear_precip_filtered=REFORM(OPEN_AND_EXTRACT(metrics_infiles(k),variable,$
                                                             offset=[box_tx(1),box_tx(0),start_read(k),j],$
                                                             count=[n_lon,n_lat,n_days,1]))*multiplier
         ENDIF ELSE BEGIN
            thisyear_precip_filtered=REFORM(OPEN_AND_EXTRACT(metrics_infiles(k),variable,$
                                                             offset=[box_tx(1),box_tx(0),j,start_read(k)],$
                                                             count=[n_lon,n_lat,1,n_days]))*multiplier
         ENDELSE
         IF TOTAL(where(thisyear_precip_filtered ge 1E20)) gt 0 THEN $
            thisyear_precip_filtered[where(thisyear_precip_filtered ge 1E20)]=!Values.F_NaN
         allyears_precip_filtered(*,*,j*n_days:(j+1)*n_days-1)=thisyear_precip_filtered
      ENDFOR
      precip_variance=fltarr(n_years,n_lon,n_lat)
      precip_variance(*,*,*)=0.
      FOR m=0,n_lon-1 DO BEGIN
         FOR n=0,n_lat-1 DO BEGIN
            thispt_mean=MEAN(allyears_precip_filtered(m,n,*),/NaN)
            FOR p=0,n_years-1 DO BEGIN
               FOR r=0,n_days-1 DO BEGIN
                  IF FINITE(allyears_precip_filtered(m,n,p*n_days+r)) eq 1 THEN $
                     precip_variance(p,m,n)=precip_variance(p,m,n)+(allyears_precip_filtered(m,n,p*n_days+r)-thispt_mean)^2*1./FLOAT(n_days)
               ENDFOR
            ENDFOR
         ENDFOR
      ENDFOR
      
      precip_stddev=fltarr(n_years,n_lon,n_lat)
      precip_stddev_scaled=fltarr(n_years,n_lon,n_lat)
      precip_clim_mean=fltarr(n_lon,n_lat)
      FOR m=0,n_lon-1 DO BEGIN
         FOR n=0,n_lat-1 DO BEGIN
            IF MEAN(clim_precip(m,n,*),/NaN) gt 1.0 THEN BEGIN
               precip_clim_mean(m,n)=MEAN(clim_precip(m,n,*),/NaN)
            ENDIF ELSE $
               precip_clim_mean(m,n)=!Values.F_NaN
         ENDFOR
      ENDFOR
      precip_clim_aavg=MEAN(precip_clim_mean(*,*),/NaN)
      FOR j=0,n_years-1 DO BEGIN
         FOR m=0,n_lon-1 DO BEGIN
            FOR n=0,n_lat-1 DO BEGIN
               IF MEAN(clim_precip(m,n,*),/NaN) gt 1.0 THEN BEGIN
                  precip_stddev(j,m,n)=SQRT(precip_variance(j,m,n))
;                  precip_clim_mean(m,n)=MEAN(clim_precip(m,n,*),/NaN)
               ENDIF ELSE $
                  precip_stddev(j,m,n)=!Values.F_NaN
;                  precip_clim_mean(m,n)=!Values.F_NaN
;               precip_stddev_scaled(j,m,n)=precip_stddev(j,m,n)/MEAN(clim_precip(m,n,*),/NaN)
            ENDFOR
         ENDFOR
         metrics(i+n_sets*k,j)=MEAN(precip_stddev(j,*,*),/NaN)
         metrics_scaled(i+n_sets*k,j)=metrics(i+n_sets*k,j)/precip_clim_aavg
      ENDFOR
   ENDFOR
   
   IF i eq 0 THEN BEGIN
      FOR k=0,n_metrics-1 DO $
         metrics_obs(k,*)=metrics_scaled(n_sets*k,*)
   ENDIF ELSE BEGIN
      FOR k=0,n_metrics-1 DO BEGIN
         metrics_norm_obs(i+n_sets*k,*)=metrics_scaled(i+n_sets*k,*)/MEAN(metrics_obs(k,0:obs_nyears-1))
      ENDFOR
   ENDELSE
 
   IF n_years LT max_years THEN BEGIN
      FOR k=0,n_metrics-1 DO BEGIN
         metrics(i+n_sets*k,n_years:max_years-1)=missing
         metrics_scaled(i+n_sets*k,n_years:max_years-1)=missing
         metrics_norm_obs(i+n_sets*k,n_years:max_years-1)=missing
      ENDFOR
   ENDIF
   
   FOR k=0,n_metrics-1 DO $
      xlabels(i+n_sets*k)=plot_title ;+' '+metric_names(k)        
   
ENDFOR

;psfile='/home/ss901165/idl/hadgem3_monwg/isv_metrics/hadgem3_monwg_isv_metrics_box_whisker.allinone.ps'
;set_plot,'ps'
;device,file=psfile,bits_per_pixel=24,set_font='Hershey',/color
;BoxPlot,metrics,labels=xlabels,missing_data_value=missing,yrange=[0,9],ystyle=1,$
;  ytitle='Stddev in area-avg, filtered rain for July and Aug',thick=3,charthick=1.50,$
;  xthick=3,ythick=3,rotate=45,charsize=1.20,color="black"
;device,/close
set_plot,'ps'

range=fltarr(n_metrics,2)
range_scaled=fltarr(n_metrics,2)
range_norm=fltarr(n_metrics,2)
range(0,*)=[0,4]
range_scaled(0,*)=[0,0.8]
range_norm(0,*)=[0.25,1.50]
range(1,*)=[0,5]
range_scaled(1,*)=[0,0.6]
range_norm(1,*)=[0.25,1.5]
range(2,*)=[0,9]
range_scaled(2,*)=[0,1.5]
range_norm(2,*)=[0.25,1.5]
range(3,*)=[0,8]
range_scaled(3,*)=[0,1.2]
range_norm(3,*)=[0.25,1.5]
range(4,*)=[1,3.5]
range_scaled(4,*)=[0,0.6]
range_norm(4,*)=[0.25,1.5]
range(5,*)=[2,5]
range_scaled(5,*)=[0,1.2]
range_norm(5,*)=[0.25,1.5]
range(6,*)=[4,12]
range_scaled(6,*)=[0.5,2]
range_norm(6,*)=[0.25,1.5]
FOR i=0,n_metrics-1 DO BEGIN
   print,i
   psfile='/home/ss901165/idl/hadgem3_monwg/isv_metrics/hadgem3_monwg_isv_metrics_box_whisker.part'+STRTRIM(STRING(i),1)+'_captivate.ps'
   PSOPEN,file=psfile,FONT=2,CHARSIZE=110,MARGIN=1200,SPACE2=200,XOFFSET=2000,YOFFSET=1500,TFONT=2,TCHARSIZE=100,SPACE3=400
   black=FSC_COLOR("black",2)
   red=FSC_COLOR("red",3)
   blue=FSC_COLOR("blue",4)
   cyan=FSC_COLOR("cyan",5)
   purple=FSC_COLOR("purple",6)
   brown=FSC_COLOR("brown",7)
   orange=FSC_COLOR("orange",8)
   GSET,XMIN=0,XMAX=n_sets,YMIN=REFORM(range(i,0)),YMAX=REFORM(range(i,1)),TITLE=REFORM(titles(i))
   FOR j=0,n_sets-1 DO BEGIN
      this_metric_values=metrics(i*n_sets+j,*)
      this_metric_values=this_metric_values[where(this_metric_values ne missing)]
      this_metric_values=this_metric_values[SORT(this_metric_values)]
      EBAR,X=j+0.5,BOX=[MIN(this_metric_values),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/4)),$
                        this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/2)),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)*3/4)),$
                        MAX(this_metric_values)],width=200,COL=colors(j),thick=200
   ENDFOR
   ystep=range(i,1)/10.
   AXES,XVALS=indgen(n_sets)+0.5,XLABELS=xlabels(i*n_sets:(i+1)*n_sets-1),YSTEP=ystep(0),$
        XTITLE='Model integration',YTITLE='Standard deviation in area-avg, filtered rain for July and Aug',NDECS=2
   GLEGEND,labels=REVERSE(legend_items),COL=REVERSE(legend_colors),LEGPOS=9
   ;device,file=psfile,bits_per_pixel=24;,set_font='Hershey',/color
   ;BoxPlot,metrics(i*n_sets:(i+1)*n_sets-1,*),labels=xlabels(i*n_sets:(i+1)*n_sets-1),missing_data_value=missing,$
   ;        yrange=REFORM(range(i,*)),ystyle=1,ytitle='Stddev in area-avg, filtered rain for July and Aug',$
   ;        thick=3,charthick=1.50,xthick=3,ythick=3,rotate=45,charsize=1.20,title=titles(i)
   ;device,/close
   PSCLOSE,/NOVIEW

   psfile='/home/ss901165/idl/hadgem3_monwg/isv_metrics/hadgem3_monwg_isv_metrics_box_whisker.part'+STRTRIM(STRING(i),1)+'_scaled_captivate.ps'
   PSOPEN,file=psfile,FONT=2,CHARSIZE=110,MARGIN=1800,SPACE2=200,XOFFSET=2000,YOFFSET=1500,TFONT=2,TCHARSIZE=100,SPACE3=400
   black=FSC_COLOR("black",2)
   red=FSC_COLOR("red",3)
   blue=FSC_COLOR("blue",4)
   cyan=FSC_COLOR("cyan",5)
   purple=FSC_COLOR("purple",6)
   brown=FSC_COLOR("brown",7)
   orange=FSC_COLOR("orange",8)
   GSET,XMIN=0,XMAX=n_sets,YMIN=REFORM(range_scaled(i,0)),YMAX=REFORM(range_scaled(i,1)),TITLE=REFORM(titles(i))
   FOR j=0,n_sets-1 DO BEGIN
      this_metric_values=metrics_scaled(i*n_sets+j,*)
      this_metric_values=this_metric_values[where(this_metric_values ne missing)]
      this_metric_values=this_metric_values[SORT(this_metric_values)]
      EBAR,X=j+0.5,BOX=[MIN(this_metric_values),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/4)),$
                        this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/2)),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)*3/4)),$
                        MAX(this_metric_values)],width=200,COL=colors(j),thick=200
   ENDFOR
   ystep=range_scaled(i,1)/10.
   AXES,XVALS=indgen(n_sets)+0.5,XLABELS=xlabels(i*n_sets:(i+1)*n_sets-1),YSTEP=ystep(0),$
        XTITLE='Model integration',YTITLE='Standard deviation in area-avg, filtered rain for July and Aug scaled by mean rainfall',NDECS=2
   GLEGEND,labels=REVERSE(legend_items),COL=REVERSE(legend_colors),LEGPOS=9
;   device,file=psfile,bits_per_pixel=24;,set_font='Hershey',/color
;   BoxPlot,metrics_scaled(i*n_sets:(i+1)*n_sets-1,*),labels=xlabels(i*n_sets:(i+1)*n_sets-1),missing_data_value=missing,$
;           yrange=REFORM(range_scaled(i,*)),ystyle=1,ytitle='Stddev in area-avg, filtered rain for July and Aug scaled by mean',$
;           thick=3,charthick=1.50,xthick=3,ythick=3,rotate=45,charsize=1.20,title=titles(i)
;   device,/close
   PSCLOSE,/NOVIEW
   
   psfile='/home/ss901165/idl/hadgem3_monwg/isv_metrics/hadgem3_monwg_isv_metrics_box_whisker.part'+STRTRIM(STRING(i),1)+'_normobs_captivate.ps'
   PSOPEN,file=psfile,FONT=2,CHARSIZE=110,MARGIN=1200,SPACE2=200,XOFFSET=2000,YOFFSET=1500,TFONT=2,TCHARSIZE=100,SPACE3=400
   black=FSC_COLOR("black",2)
   red=FSC_COLOR("red",3)
   blue=FSC_COLOR("blue",4)
   cyan=FSC_COLOR("cyan",5)
   purple=FSC_COLOR("purple",6)
   brown=FSC_COLOR("brown",7)
   orange=FSC_COLOR("orange",8)
   GSET,XMIN=0,XMAX=n_sets-1,YMIN=REFORM(range_norm(i,0)),YMAX=REFORM(range_norm(i,1)),TITLE=REFORM(titles(i))
   FOR j=1,n_sets-1 DO BEGIN
      this_metric_values=metrics_norm_obs(i*n_sets+j,*)
      this_metric_values=this_metric_values[where(this_metric_values ne missing)]
      this_metric_values=this_metric_values[SORT(this_metric_values)]
      EBAR,X=j-0.5,BOX=[MIN(this_metric_values),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/4)),$
                        this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/2)),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)*3/4)),$
                        MAX(this_metric_values)],width=200,COL=colors(j),thick=200
      GPLOT,X=indgen(n_sets),Y=REPLICATE(1,n_sets),THICK=150,STYLE=2
      GPLOT,X=indgen(n_sets),Y=REPLICATE(1.3,n_sets),THICK=150,STYLE=1
      GPLOT,X=indgen(n_sets),Y=REPLICATE(0.7,n_sets),THICK=150,STYLE=1
      ;GPLOT,X=indgen(n_sets),Y=REPLICATE((STDDEV(metrics_obs(i,0:obs_nyears-1))+MEAN(metrics_obs(i,0:obs_nyears-1)))/MEAN(metrics_obs(i,0:obs_nyears-1)),n_sets),THICK=1.5,STYLE=1
;      GPLOT,X=indgen(n_sets),Y=REPLICATE((MEAN(metrics_obs(i,0:obs_nyears-1))-STDDEV(metrics_obs(i,0:obs_nyears-1)))/MEAN(metrics_obs(i,0:obs_nyears-1)),n_sets),THICK=1.5,STYLE=1
;      GPLOT,X=indgen(n_sets),Y=REPLICATE((MEAN(metrics_obs(i,0:obs_nyears-1))-STDDEV(metrics_obs(i,0:obs_nyears-1)))/MEAN(metrics_obs(i,0:obs_nyears-1)),n_sets),THICK=1.5,STYLE=1
   ENDFOR
   ystep=range_norm(i,1)/10.
   AXES,XVALS=indgen(n_sets-1)+0.5,XLABELS=xlabels(i*n_sets+1:(i+1)*n_sets-1),YSTEP=ystep(0),$
        XTITLE='Model integration',YTITLE='Ratio: (model_variability/model_mean) / (observed_variability/observed_mean)',NDECS=2
   GLEGEND,labels=REVERSE(legend_items),COL=REVERSE(legend_colors),LEGPOS=9
;   device,file=psfile,bits_per_pixel=24;,set_font='Hershey',/color
;   BoxPlot,metrics_norm_obs(i*n_sets+1:(i+1)*n_sets-1,*),labels=xlabels(i*n_sets+1:(i+1)*n_sets-1),missing_data_value=missing,$
;           yrange=REFORM(range_norm(i,*)),ystyle=1,ytitle='Stddev in area-avg, filtered rain for July and Aug scaled by mean',$
;           thick=3,charthick=1.50,xthick=3,ythick=3,rotate=45,charsize=1.20,title=titles(i)
;   oplot,indgen(100)*0.1,REPLICATE(1,100),thick=1.5
;   oplot,indgen(100)*0.1,REPLICATE((stddev(metrics_obs(i,0:obs_nyears-1))+mean(metrics_obs(i,0:obs_nyears-1)))/mean(metrics_obs(i,0:obs_nyears-1)),10;0),thick=1.5,linestyle=1
;   oplot,indgen(100)*0.1,REPLICATE((mean(metrics_obs(i,0:obs_nyears-1))-stddev(metrics_obs(i,0:obs_nyears-1)))/mean(metrics_obs(i,0:obs_nyears-1)),100),thick=1.5,linestyle=1
;   device,/close
   PSCLOSE,/NOVIEW

ENDFOR

                                ; FOR k=0,n_metrics-1 DO BEGIN
;         this_metric=REFORM(metrics(k,*))
;         sorted_metric=this_metric[Sort(this_metric)]
;         IF N_ELEMENTS(sorted_metric) MOD 2 EQ 0 THEN BEGIN
;             index=N_ELEMENTS(sorted_metric)/2
;             medianData=(sorted_metric[index-1]+sorted_metric[index])/2.0
;             lowerGroup=sorted_metric[0:index-1]
;             higherGroup=sorted_metric[index:N_ELEMENTS(sorted_metric)-1]
;         ENDIF ELSE BEGIN
;             index=N_ELEMENTS(sorted_metric)/2
;             medianData=sorted_metric[index]
;             lowerGroup=sorted_metric[0:index-1]
;             higherGroup=sorted_metric[index+1:N_ELEMENTS(sorted_metric)-1]
;         ENDELSE
;         quartile_25=Median(lowerGroup,/EVEN)
;         quartile_75=Median(higherGroup,/EVEN)
;         irq=quartile_75-quartile_25

;         min_metric=MIN(this_metric,MAX=max_metric)
;         halfwidth=width/2.0
;         x1=xlocation-halfwidth
;         x2=xlocation+halfwidth
;         y1=quartile_25
;         y2=quartile_75
;         PLOTS,[x1,x1,x2,x2,x1],[y1,y2,y2,y1,y1]
;         PLOTS,[x1,x2],[medianData,medianData]

;         imax=WHERE(this_metric GT quartile_75 + (1.5*irq),maxcount)
;         IF maxcount EQ 0 THEN BEGIN
;             top=max_metric
;         ENDIF ELSE BEGIN
;             index=Value_Locate(sorted_metric,quartile_75+(1.5*irq))
;             top=sorted_metric[0 > (index) < (N_ELEMENTS(this_metric)-1)]
;         ENDELSE

;         imin=WHERE(this_metric LT quartile_25 - (1.5*irq),mincount)
;         IF mincount EQ 0 THEN BEGIN
;             bottom=min_metric
;         ENDIF ELSE BEGIN
;             index=Value_Locate(sorted_metric,quartile_25-(1.5*irq))
;             bottom=sorted_metric[0 > (index+1) < (N_ELEMENTS(this_metric)-1)]
;         ENDELSE

;         PLOTS,[xlocation,xlocation],[quartile_75,top]
;         PLOTS,[xlocation,xlocation],[quartile_25,bottom]
;         PLOTS, [xlocation - (halfwidth*0.5), xlocation + (halfwidth*0.5)], $
;           [top, top], COLOR=FSC_Color(color)
;         PLOTS, [xlocation - (halfwidth*0.5), xlocation + (halfwidth*0.5)], $
;           [bottom, bottom], COLOR=FSC_Color(color)

;                                 ; Draw outliners if there are any.
;         IF maxcount GT 0 THEN BEGIN
;             FOR m=0,maxcount-1 DO PLOTS, xlocation, this_metric[imax[m]];, $
;                                 ;PSYM=SymCat(9), COLOR=FSC_Color(color)
;         ENDIF
;         IF mincount GT 0 THEN BEGIN
;             FOR m=0,mincount-1 DO PLOTS, xlocation, this_metric[imin[m]];, $
;                                 ;PSYM=SymCat(9), COLOR=FSC_Color(color)
;         ENDIF

;     ENDFOR

STOP

END

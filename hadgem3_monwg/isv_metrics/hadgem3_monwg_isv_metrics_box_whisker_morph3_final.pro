PRO hadgem3_monwg_isv_metrics_box_whisker_morph3_final

trmm_n96_1020_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n96/TRMM_3B42v6A.1999-2008.apr-oct_anom_filter1020.dmeans.monsoon_domain.n96.nc'
trmm_n96_3050_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n96/TRMM_3B42v6A.1999-2008.apr-oct_anom_filter3050.dmeans.monsoon_domain.n96.nc'
trmm_n96_2120_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n96/TRMM_3B42v6A.1999-2008.apr-oct_anom_filter2120.dmeans.monsoon_domain.n96.nc'
trmm_n96_clim_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n96/TRMM_3B42v6A.1999-2008.apr-oct_clim.dmeans.monsoon_domain.n96.nc'

trmm_n216_1020_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n216/TRMM_3B42v6A.1999-2008.apr-oct_anom_filter1020.nc'
trmm_n216_3050_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n216/TRMM_3B42v6A.1999-2008.apr-oct_anom_filter3050.nc'
trmm_n216_clim_file='/home/ss901165/datasets_mango/TRMM_3B42V6/n216/TRMM_3B42v6A.1999-2008.apr-oct_clim.dmeans.monsoon_domain.nwp_n216.nc'

ahrqc_1020_file='/home/ss901165/um_output3/hadgem3_monwg/ahrqc/ahrqc.precip.apr-oct.daily_20years.anom_filter1020.nc'
ahrqc_3050_file='/home/ss901165/um_output3/hadgem3_monwg/ahrqc/ahrqc.precip.apr-oct.daily_20years.anom_filter3050.nc'
ahrqc_clim_file='/home/ss901165/um_output3/hadgem3_monwg/ahrqc/ahrqc.precip.apr-oct.clim.daily_20years.nc'

ahjra_1020_file='/home/ss901165/um_output3/hadgem3_monwg/ahjra/ahjra.precip.apr-oct.daily_20years.anom_filter1020.nc'
ahjra_3050_file='/home/ss901165/um_output3/hadgem3_monwg/ahjra/ahjra.precip.apr-oct.daily_20years.anom_filter3050.nc'
ahjra_clim_file='/home/ss901165/um_output3/hadgem3_monwg/ahjra/ahjra.precip.apr-oct.clim.daily_20years.nc'

ahsaf_1020_file='/home/ss901165/um_output3/hadgem3_monwg/ahsaf/ahsaf.precip.apr-oct.daily_30years.anom_filter1020.nc'
ahsaf_3050_file='/home/ss901165/um_output3/hadgem3_monwg/ahsaf/ahsaf.precip.apr-oct.daily_30years.anom_filter3050.nc'
ahsaf_clim_file='/home/ss901165/um_output3/hadgem3_monwg/ahsaf/ahsaf.precip.clim.daily_30years.nc'

ahtpl_1020_file='/home/ss901165/um_output3/hadgem3_monwg/ahtpl/ahtpl.precip.apr-oct.daily_12years.anom_filter1020.nc'
ahtpl_3050_file='/home/ss901165/um_output3/hadgem3_monwg/ahtpl/ahtpl.precip.apr-oct.daily_12years.anom_filter3050.nc'
ahtpl_clim_file='/home/ss901165/um_output3/hadgem3_monwg/ahtpl/ahtpl.precip.apr-oct.clim.daily_12years.nc'

ahhbs_1020_file='/home/ss901165/um_output3/hadgem3_monwg/ahhbs/ahhbs.precip.apr-oct.daily_9years.anom_filter1020.nc'
ahhbs_3050_file='/home/ss901165/um_output3/hadgem3_monwg/ahhbs/ahhbs.precip.apr-oct.daily_9years.anom_filter3050.nc'
ahhbs_clim_file='/home/ss901165/um_output3/hadgem3_monwg/ahhbs/ahhbs.precip.apr-oct.clim.daily_9years.nc'

; HadGEM3-A N96L85 AMIP2 assessment #2
aiaux_1020_file='/home/ss901165/um_output3/hadgem3_monwg/aiaux/aiaux.apr-oct_dmeans.h9-j8.precip_filter_1020.nc'
aiaux_3050_file='/home/ss901165/um_output3/hadgem3_monwg/aiaux/aiaux.apr-oct_dmeans.h9-j8.precip_filter_3050.nc'
aiaux_2120_file='/home/ss901165/um_output3/hadgem3_monwg/aiaux/aiaux.apr-oct_dmeans.h9-j8.precip_filter_2120.nc'
aiaux_clim_file='/home/ss901165/um_output3/hadgem3_monwg/aiaux/aiaux.apr-oct_dmeans_clim.h9-j8.precip.nc'

; HadGEM3-HA N216L63 AMIP2 assessment #2
ailso_1020_file='/home/ss901165/um_output3/hadgem3_monwg/ailso/ailso.precip.apr-oct.daily_18years.anom_filter1020.nc'
ailso_3050_file='/home/ss901165/um_output3/hadgem3_monwg/ailso/ailso.precip.apr-oct.daily_18years.anom_filter3050.nc'
ailso_2120_file='/home/ss901165/um_output3/hadgem3_monwg/ailso/ailso.precip.apr-oct.daily_20years.anom_filter2120.nc'
ailso_clim_file='/home/ss901165/um_output3/hadgem3_monwg/ailso/ailso.precip.apr-oct.clim.daily_18years.nc'

; HadGEM3-AO N96L85 ORCA1L42-24H assesment #2
aitcb_1020_file='/home/ss901165/um_output3/hadgem3_monwg/aitcb/aitcb.jan-dec_dmeans.h9-j8.precip_filter_1020.nc'
aitcb_3050_file='/home/ss901165/um_output3/hadgem3_monwg/aitcb/aitcb.jan-dec_dmeans.h9-j8.precip_filter_3050.nc'
aitcb_2120_file='/home/ss901165/um_output3/hadgem3_monwg/aitcb/aitcb.jan-dec_dmeans.h9-j8.precip_filter_2120.nc'
aitcb_clim_file='/home/ss901165/um_output3/hadgem3_monwg/aitcb/aitcb.jan-dec_dmeans_clim.h9-j8.precip.nc'

; HadGEM3-AO N96L85 ORCA1L75-24H assessment #2
aitke_1020_file='/home/ss901165/um_output3/hadgem3_monwg/aitke/aitke.jan-dec_dmeans.i0-j2.precip_filter_1020.nc'
aitke_3050_file='/home/ss901165/um_output3/hadgem3_monwg/aitke/aitke.jan-dec_dmeans.i0-j2.precip_filter_3050.nc'
aitke_clim_file='/home/ss901165/um_output3/hadgem3_monwg/aitke/aitke.jan-dec_dmeans_clim.i0-j2.precip.nc'

; HadGEM3-AO N96L85 ORCA1L75-3H assessment #2
aitkh_1020_file='/home/ss901165/um_output3/hadgem3_monwg/aitkh/aitkh.jan-dec_dmeans.h9-i8.precip_filter_1020.nc'
aitkh_3050_file='/home/ss901165/um_output3/hadgem3_monwg/aitkh/aitkh.jan-dec_dmeans.h9-i8.precip_filter_3050.nc'
aitkh_clim_file='/home/ss901165/um_output3/hadgem3_monwg/aitkh/aitkh.jan-dec_dmeans_clim.h9-i8.precip.nc'

; HadGEM3-A N96L85 MORPH3 final assessment
airxv_1020_file='/home/ss901165/um_output3/hadgem3_monwg/airxv/hadgem3a_morph3_final_n96_amip2_airxv.jan-dec_dmeans_anom_filter1020.1982-2008.precip.nc'
airxv_3050_file='/home/ss901165/um_output3/hadgem3_monwg/airxv/hadgem3a_morph3_final_n96_amip2_airxv.jan-dec_dmeans_anom_filter3050.1982-2008.precip.nc'
airxv_2120_file='/home/ss901165/um_output3/hadgem3_monwg/airxv/hadgem3a_morph3_final_n96_amip2_airxv.jan-dec_dmeans_anom_filter2120.1982-2008.precip.nc'
airxv_clim_file='/home/ss901165/um_output3/hadgem3_monwg/airxv/hadgem3a_morph3_final_n96_amip2_airxv.jan-dec_dmeans_clim.1982-2008.precip.nc'

; HadGEM3-AO N96L85 ORCA1 MORPH3 final assessment
aicvx_1020_file='/home/ss901165/um_output3/hadgem3_monwg/aicvx/hadgem3ao_morph3_final_n96_orca1_aicvx.jan-dec_dmeans_anom_filter1020.years1-30.precip.nc'
aicvx_3050_file='/home/ss901165/um_output3/hadgem3_monwg/aicvx/hadgem3ao_morph3_final_n96_orca1_aicvx.jan-dec_dmeans_anom_filter3050.years1-30.precip.nc'
aicvx_2120_file='/home/ss901165/um_output3/hadgem3_monwg/aicvx/hadgem3ao_morph3_final_n96_orca1_aicvx.jan-dec_dmeans_anom_filter2120.years1-30.precip.nc'
aicvx_clim_file='/home/ss901165/um_output3/hadgem3_monwg/aicvx/hadgem3ao_morph3_final_n96_orca1_aicvx.jan-dec_dmeans_clim.years1-30.precip.nc'

; HadGEM2-A N96L38(?) final run - for comparison to MORPH3
ageyb_1020_file='/home/ss901165/um_output3/hadgem3_monwg/ageyb/hadgem2a_final_n96_amip2_ageyb.jan-dec_dmeans_anom_filter1020.1979-1998.precip.nc'
ageyb_3050_file='/home/ss901165/um_output3/hadgem3_monwg/ageyb/hadgem2a_final_n96_amip2_ageyb.jan-dec_dmeans_anom_filter3050.1979-1998.precip.nc'
ageyb_2120_file='/home/ss901165/um_output3/hadgem3_monwg/ageyb/hadgem2a_final_n96_amip2_ageyb.jan-dec_dmeans_anom_filter2120.1979-1998.precip.nc'
ageyb_clim_file='/home/ss901165/um_output3/hadgem3_monwg/ageyb/hadgem2a_final_n96_amip2_ageyb.jan-dec_dmeans_clim.1979-1998.precip.nc'

; HadGEM2-AO N96L38(?) final run - for comparison to MORPH3
agkfc_1020_file='/home/ss901165/um_output3/hadgem3_monwg/agkfc/hadgem2ao_final_n96_agkfc.jan-dec_dmeans_anom_filter1020.years1-30.precip.nc'
agkfc_3050_file='/home/ss901165/um_output3/hadgem3_monwg/agkfc/hadgem2ao_final_n96_agkfc.jan-dec_dmeans_anom_filter3050.years1-30.precip.nc'
agkfc_2120_file='/home/ss901165/um_output3/hadgem3_monwg/agkfc/hadgem2ao_final_n96_agkfc.jan-dec_dmeans_anom_filter2120.years1-30.precip.nc'
agkfc_clim_file='/home/ss901165/um_output3/hadgem3_monwg/agkfc/hadgem2ao_final_n96_agkfc.jan-dec_dmeans_clim.years1-30.precip.nc'

n_metrics=7
boxes_metrics=fltarr(n_metrics,4)
boxes_metrics(0,*)=[-10,70,5,100]
boxes_metrics(1,*)=[10,80,20,100]
boxes_metrics(2,*)=[10,115,20,145]
boxes_metrics(3,*)=[10,80,20,100]
boxes_metrics(4,*)=[-10,50,30,150]
boxes_metrics(5,*)=[-10,50,30,150]
boxes_metrics(6,*)=[-10,50,35,150]
metric_names=['EEqIO','BoB','NWPac','BoB','MonDom']
titles=['30-50 day variability in the Eastern Equatorial Indian Ocean (10S-5N, 70-100E)',$
        '30-50 day variability in the Bay of Bengal (10-20N, 80-100E)',$
        '10-20 day variability in the NW Tropical Pacific (10-20N, 115-145E)',$
        '10-20 day variability in the Bay of Bengal (10-20N, 80-100E)',$
        '30-50 day variability across the domain (10S-30N, 50-150E)',$
        '10-20 day variability across the domain (10S-30N, 50-150E)',$
        '2-120 day variability across the domain (10S-30N, 50-150E)']

n_sets=7
max_years=40

width=10
xlocation=0.5
missing=-9999

metrics=fltarr(n_metrics*n_sets,max_years)
metrics_scaled=fltarr(n_metrics*n_sets,max_years)
metrics_obs=fltarr(n_metrics,max_years)
metrics_norm_obs=fltarr(n_metrics*n_sets,max_years)
xlabels=strarr(n_metrics*n_sets)
colors=intarr(n_sets)

black=FSC_COLOR("black",2)
red=FSC_COLOR("red",3)
blue=FSC_COLOR("blue",4)
purple=FSC_COLOR("purple",5)

legend_items=['HadGEM2 (for comparison)','HadGEM3 MORPH3 prev assess','HadGEM3 MORPH3 final assess']
legend_colors=[4,5,3]

FOR i=0,n_sets-1 DO BEGIN
   print,i
   CASE i OF
      0: BEGIN
         metrics_infiles=[trmm_n96_3050_file,trmm_n96_3050_file,trmm_n96_1020_file,trmm_n96_1020_file,trmm_n96_3050_file,trmm_n96_1020_file,trmm_n96_2120_file]
         clim_infile=trmm_n96_clim_file
         clim_start_read=90
         clim_fourd=0
         start_read=[90-50/2,90-50/2,90-20/2,90-20/2,90-50/2,90-20/2,90-120/2]
         plot_title='TRMM N96 (11yr)'  
         n_days=62
         n_years=10
         multiplier=1    
         variable='precip'
         obs_nyears=n_years
         year_dimension_last=0
         color=2
      END        
      3: BEGIN
         metrics_infiles=[aiaux_3050_file,aiaux_3050_file,aiaux_1020_file,aiaux_1020_file,aiaux_3050_file,aiaux_1020_file,aiaux_2120_file]
         clim_infile=aiaux_clim_file
         clim_start_read=90
         clim_fourd=1
         start_read=[90-50/2,90-50/2,90-20/2,90-20/2,90-50/2,90-20/2,90-120/2]
         plot_title='aiaux (A, 20yr)'
         n_days=60
         n_years=20
         multiplier=86400.
         variable='precip'
         year_dimension_last=0
         color=5
      END
      6: BEGIN
         metrics_infiles=[aitcb_3050_file,aitcb_3050_file,aitcb_1020_file,aitcb_1020_file,aitcb_3050_file,aitcb_1020_file,aitcb_2120_file]
         clim_infile=aitcb_clim_file
         clim_start_read=180
         clim_fourd=1
         start_read=[180-50/2,180-50/2,180-20/2,180-20/2,180-50/2,180-20/2,180-120/2]
         plot_title='aitcb (AO, 20yr)'
         n_days=60
         n_years=20
         multiplier=86400.
         variable='precip'
         year_dimension_last=0
         color=5
      END
;      3: BEGIN
;         metrics_infiles=[ailso_3050_file,ailso_3050_file,ailso_1020_file,ailso_1020_file,ailso_3050_file,ailso_1020_file]
;         clim_infile=ailso_clim_file
;         clim_start_read=90
;         clim_fourd=1
;         start_read=[90-50/2,90-50/2,90-20/2,90-20/2,90-50/2,90-20/2]
;         plot_title='ailso'
;         n_days=60
;         n_years=18
;         multiplier=86400.
;         variable='precip'
;      END
      2: BEGIN
         metrics_infiles=[airxv_3050_file,airxv_3050_file,airxv_1020_file,airxv_1020_file,airxv_3050_file,airxv_1020_file,airxv_2120_file]
         clim_infile=airxv_clim_file
         clim_start_read=180
         clim_fourd=0
         start_read=[180-50/2,180-50/2,180-20/2,180-20/2,180-50/2,180-20/2,180-120/2]
         plot_title='airxv (A, 27yr)'
         n_days=60
         n_years=27
         multiplier=86400.
         variable='precip'
         year_dimension_last=1
         color=3
      END     
      5: BEGIN
         metrics_infiles=[aicvx_3050_file,aicvx_3050_file,aicvx_1020_file,aicvx_1020_file,aicvx_3050_file,aicvx_1020_file,aicvx_2120_file]
         clim_infile=aicvx_clim_file
         clim_start_read=180
         clim_fourd=0
         start_read=[180-50/2,180-50/2,180-20/2,180-20/2,180-50/2,180-20/2,180-120/2]
         plot_title='aicvx (AO, 30yr)'
         n_days=60
         n_years=30
         multiplier=86400.
         variable='precip'
         year_dimension_last=1
         color=3
      END     
      1: BEGIN
         metrics_infiles=[ageyb_3050_file,ageyb_3050_file,ageyb_1020_file,ageyb_1020_file,ageyb_3050_file,ageyb_1020_file,ageyb_2120_file]
         clim_infile=ageyb_clim_file
         clim_start_read=180
         clim_fourd=0
         start_read=[180-50/2,180-50/2,180-20/2,180-20/2,180-50/2,180-20/2,180-120/2]
         plot_title='ageyb (A, 20yr)'
         n_days=60
         n_years=20
         multiplier=86400.
         variable='precip'
         year_dimension_last=1
         color=4
      END
      4: BEGIN
         metrics_infiles=[agkfc_3050_file,agkfc_3050_file,agkfc_1020_file,agkfc_1020_file,agkfc_3050_file,agkfc_1020_file,agkfc_2120_file]
         clim_infile=agkfc_clim_file
         clim_start_read=180
         clim_fourd=0
         start_read=[180-50/2,180-50/2,180-20/2,180-20/2,180-50/2,180-20/2,180-120/2]
         plot_title='agkfc (AO, 30yr)'
         n_days=60
         n_years=30
         multiplier=86400.
         variable='precip'
         year_dimension_last=1
         color=4
      END
   ENDCASE
   
   colors(i)=color
   FOR k=0,n_metrics-1 DO BEGIN
      print,k
      longitude=OPEN_AND_EXTRACT(metrics_infiles(k),'longitude')
      latitude=OPEN_AND_EXTRACT(metrics_infiles(k),'latitude')
      DEFINE_BOUNDARIES,REFORM(boxes_metrics(k,*)),latitude,longitude,box_tx,/LIMIT
      n_lon=N_ELEMENTS(longitude)
      n_lat=N_ELEMENTS(latitude)
      
      clim_longitude=OPEN_AND_EXTRACT(clim_infile,'longitude')
      clim_latitude=OPEN_AND_EXTRACT(clim_infile,'latitude')
      DEFINE_BOUNDARIES,REFORM(boxes_metrics(k,*)),clim_latitude,clim_longitude,clim_box_tx,/LIMIT
      clim_nlon=N_ELEMENTS(longitude)
      clim_nlat=N_ELEMENTS(latitude)
      clim_ndays=n_days
      
      IF clim_fourd eq 1 THEN BEGIN
         clim_precip=REFORM(OPEN_AND_EXTRACT(clim_infile,variable,$
                                             offset=[clim_box_tx(1),clim_box_tx(0),0,clim_start_read],$
                                             count=[clim_nlon,clim_nlat,1,clim_ndays]))*multiplier
      ENDIF ELSE BEGIN
         clim_precip=REFORM(OPEN_AND_EXTRACT(clim_infile,variable,$
                                             offset=[clim_box_tx(1),clim_box_tx(0),clim_start_read],$
                                             count=[clim_nlon,clim_nlat,clim_ndays]))*multiplier
      ENDELSE
      IF TOTAL(where(clim_precip ge 1E20)) gt 0 THEN $
         clim_precip[where(clim_precip ge 1E20)]=!Values.F_NaN
      
      clim_precip_aavg_seasmean=MEAN(clim_precip(*,*,*),/NaN)
      
      allyears_precip_filtered=fltarr(n_lon,n_lat,n_days*n_years)
      FOR j=0,n_years-1 DO BEGIN
         IF year_dimension_last eq 1 THEN BEGIN
            thisyear_precip_filtered=REFORM(OPEN_AND_EXTRACT(metrics_infiles(k),variable,$
                                                             offset=[box_tx(1),box_tx(0),start_read(k),j],$
                                                             count=[n_lon,n_lat,n_days,1]))*multiplier
         ENDIF ELSE BEGIN
            thisyear_precip_filtered=REFORM(OPEN_AND_EXTRACT(metrics_infiles(k),variable,$
                                                             offset=[box_tx(1),box_tx(0),j,start_read(k)],$
                                                             count=[n_lon,n_lat,1,n_days]))*multiplier
         ENDELSE
         IF TOTAL(where(thisyear_precip_filtered ge 1E20)) gt 0 THEN $
            thisyear_precip_filtered[where(thisyear_precip_filtered ge 1E20)]=!Values.F_NaN
         allyears_precip_filtered(*,*,j*n_days:(j+1)*n_days-1)=thisyear_precip_filtered
      ENDFOR
      precip_variance=fltarr(n_years,n_lon,n_lat)
      precip_variance(*,*,*)=0.
      FOR m=0,n_lon-1 DO BEGIN
         FOR n=0,n_lat-1 DO BEGIN
            thispt_mean=MEAN(allyears_precip_filtered(m,n,*),/NaN)
            FOR p=0,n_years-1 DO BEGIN
               FOR r=0,n_days-1 DO BEGIN
                  IF FINITE(allyears_precip_filtered(m,n,p*n_days+r)) eq 1 THEN $
                     precip_variance(p,m,n)=precip_variance(p,m,n)+(allyears_precip_filtered(m,n,p*n_days+r)-thispt_mean)^2*1./FLOAT(n_days)
               ENDFOR
            ENDFOR
         ENDFOR
      ENDFOR
      
      precip_stddev=fltarr(n_years,n_lon,n_lat)
      precip_stddev_scaled=fltarr(n_years,n_lon,n_lat)
      precip_clim_mean=fltarr(n_lon,n_lat)
      FOR m=0,n_lon-1 DO BEGIN
         FOR n=0,n_lat-1 DO BEGIN
            IF MEAN(clim_precip(m,n,*),/NaN) gt 1.0 THEN BEGIN
               precip_clim_mean(m,n)=MEAN(clim_precip(m,n,*),/NaN)
            ENDIF ELSE $
               precip_clim_mean(m,n)=!Values.F_NaN
         ENDFOR
      ENDFOR
      precip_clim_aavg=MEAN(precip_clim_mean(*,*),/NaN)
      FOR j=0,n_years-1 DO BEGIN
         FOR m=0,n_lon-1 DO BEGIN
            FOR n=0,n_lat-1 DO BEGIN
               IF MEAN(clim_precip(m,n,*),/NaN) gt 1.0 THEN BEGIN
                  precip_stddev(j,m,n)=SQRT(precip_variance(j,m,n))
;                  precip_clim_mean(m,n)=MEAN(clim_precip(m,n,*),/NaN)
               ENDIF ELSE $
                  precip_stddev(j,m,n)=!Values.F_NaN
;                  precip_clim_mean(m,n)=!Values.F_NaN
;               precip_stddev_scaled(j,m,n)=precip_stddev(j,m,n)/MEAN(clim_precip(m,n,*),/NaN)
            ENDFOR
         ENDFOR
         metrics(i+n_sets*k,j)=MEAN(precip_stddev(j,*,*),/NaN)
         metrics_scaled(i+n_sets*k,j)=metrics(i+n_sets*k,j)/precip_clim_aavg
      ENDFOR
   ENDFOR
   
   IF i eq 0 THEN BEGIN
      FOR k=0,n_metrics-1 DO $
         metrics_obs(k,*)=metrics_scaled(n_sets*k,*)
   ENDIF ELSE BEGIN
      FOR k=0,n_metrics-1 DO BEGIN
         metrics_norm_obs(i+n_sets*k,*)=metrics_scaled(i+n_sets*k,*)/MEAN(metrics_obs(k,0:obs_nyears-1))
      ENDFOR
   ENDELSE
 
   IF n_years LT max_years THEN BEGIN
      FOR k=0,n_metrics-1 DO BEGIN
         metrics(i+n_sets*k,n_years:max_years-1)=missing
         metrics_scaled(i+n_sets*k,n_years:max_years-1)=missing
         metrics_norm_obs(i+n_sets*k,n_years:max_years-1)=missing
      ENDFOR
   ENDIF
   
   FOR k=0,n_metrics-1 DO $
      xlabels(i+n_sets*k)=plot_title ;+' '+metric_names(k)        
   
ENDFOR

;psfile='/home/ss901165/idl/hadgem3_monwg/isv_metrics/hadgem3_monwg_isv_metrics_box_whisker.allinone.ps'
;set_plot,'ps'
;device,file=psfile,bits_per_pixel=24,set_font='Hershey',/color
;BoxPlot,metrics,labels=xlabels,missing_data_value=missing,yrange=[0,9],ystyle=1,$
;  ytitle='Stddev in area-avg, filtered rain for July and Aug',thick=3,charthick=1.50,$
;  xthick=3,ythick=3,rotate=45,charsize=1.20,color="black"
;device,/close
set_plot,'ps'

range=fltarr(n_metrics,2)
range_scaled=fltarr(n_metrics,2)
range_norm=fltarr(n_metrics,2)
range(0,*)=[0,4]
range_scaled(0,*)=[0,0.8]
range_norm(0,*)=[0.25,1.50]
range(1,*)=[0,5]
range_scaled(1,*)=[0,0.6]
range_norm(1,*)=[0.25,1.5]
range(2,*)=[0,9]
range_scaled(2,*)=[0,1.0]
range_norm(2,*)=[0.25,1.5]
range(3,*)=[0,8]
range_scaled(3,*)=[0,0.9]
range_norm(3,*)=[0.25,1.5]
range(4,*)=[1,3.5]
range_scaled(4,*)=[0,0.6]
range_norm(4,*)=[0.25,1.5]
range(5,*)=[2,5]
range_scaled(5,*)=[0,0.9]
range_norm(5,*)=[0.25,1.5]
range(6,*)=[4,12]
range_scaled(6,*)=[0.5,2]
range_norm(6,*)=[0.25,1.5]
FOR i=0,n_metrics-1 DO BEGIN
   print,i
   psfile='/home/ss901165/idl/hadgem3_monwg/isv_metrics/hadgem3_monwg_isv_metrics_box_whisker.part'+STRTRIM(STRING(i),1)+'_morph3.ps'
   PSOPEN,file=psfile,FONT=2,CHARSIZE=110,MARGIN=1200,SPACE2=200,XOFFSET=2000,YOFFSET=1500,TFONT=2,TCHARSIZE=100,SPACE3=400
   black=FSC_COLOR("black",2)
   red=FSC_COLOR("red",3)
   blue=FSC_COLOR("blue",4)
   purple=FSC_COLOR("purple",5)
   GSET,XMIN=0,XMAX=n_sets,YMIN=REFORM(range(i,0)),YMAX=REFORM(range(i,1)),TITLE=REFORM(titles(i))
   FOR j=0,n_sets-1 DO BEGIN
      this_metric_values=metrics(i*n_sets+j,*)
      this_metric_values=this_metric_values[where(this_metric_values ne missing)]
      this_metric_values=this_metric_values[SORT(this_metric_values)]
      EBAR,X=j+0.5,BOX=[MIN(this_metric_values),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/4)),$
                        this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/2)),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)*3/4)),$
                        MAX(this_metric_values)],width=166,COL=colors(j)
   ENDFOR
   ystep=range(i,1)/10.
   AXES,XVALS=indgen(n_sets)+0.5,XLABELS=xlabels(i*n_sets:(i+1)*n_sets-1),YSTEP=ystep(0),$
        XTITLE='Model integration',YTITLE='Standard deviation in area-avg, filtered rain for July and Aug',NDECS=2
   LEGEND,labels=legend_items,COL=legend_colors,LEGPOS=9
   ;device,file=psfile,bits_per_pixel=24;,set_font='Hershey',/color
   ;BoxPlot,metrics(i*n_sets:(i+1)*n_sets-1,*),labels=xlabels(i*n_sets:(i+1)*n_sets-1),missing_data_value=missing,$
   ;        yrange=REFORM(range(i,*)),ystyle=1,ytitle='Stddev in area-avg, filtered rain for July and Aug',$
   ;        thick=3,charthick=1.50,xthick=3,ythick=3,rotate=45,charsize=1.20,title=titles(i)
   ;device,/close
   PSCLOSE,/NOVIEW

   psfile='/home/ss901165/idl/hadgem3_monwg/isv_metrics/hadgem3_monwg_isv_metrics_box_whisker.part'+STRTRIM(STRING(i),1)+'_scaled_morph3.ps'
   PSOPEN,file=psfile,FONT=2,CHARSIZE=110,MARGIN=1800,SPACE2=200,XOFFSET=2000,YOFFSET=1500,TFONT=2,TCHARSIZE=100,SPACE3=400
   black=FSC_COLOR("black",2)
   red=FSC_COLOR("red",3)
   blue=FSC_COLOR("blue",4)
   purple=FSC_COLOR("purple",5)
   GSET,XMIN=0,XMAX=n_sets,YMIN=REFORM(range_scaled(i,0)),YMAX=REFORM(range_scaled(i,1)),TITLE=REFORM(titles(i))
   FOR j=0,n_sets-1 DO BEGIN
      this_metric_values=metrics_scaled(i*n_sets+j,*)
      this_metric_values=this_metric_values[where(this_metric_values ne missing)]
      this_metric_values=this_metric_values[SORT(this_metric_values)]
      EBAR,X=j+0.5,BOX=[MIN(this_metric_values),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/4)),$
                        this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/2)),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)*3/4)),$
                        MAX(this_metric_values)],width=166,COL=colors(j)
   ENDFOR
   ystep=range_scaled(i,1)/10.
   AXES,XVALS=indgen(n_sets)+0.5,XLABELS=xlabels(i*n_sets:(i+1)*n_sets-1),YSTEP=ystep(0),$
        XTITLE='Model integration',YTITLE='Standard deviation in area-avg, filtered rain for July and Aug scaled by mean rainfall',NDECS=2
   LEGEND,labels=legend_items,COL=legend_colors,LEGPOS=9
;   device,file=psfile,bits_per_pixel=24;,set_font='Hershey',/color
;   BoxPlot,metrics_scaled(i*n_sets:(i+1)*n_sets-1,*),labels=xlabels(i*n_sets:(i+1)*n_sets-1),missing_data_value=missing,$
;           yrange=REFORM(range_scaled(i,*)),ystyle=1,ytitle='Stddev in area-avg, filtered rain for July and Aug scaled by mean',$
;           thick=3,charthick=1.50,xthick=3,ythick=3,rotate=45,charsize=1.20,title=titles(i)
;   device,/close
   PSCLOSE,/NOVIEW
   
   psfile='/home/ss901165/idl/hadgem3_monwg/isv_metrics/hadgem3_monwg_isv_metrics_box_whisker.part'+STRTRIM(STRING(i),1)+'_normobs_morph3.ps'
   PSOPEN,file=psfile,FONT=2,CHARSIZE=110,MARGIN=1200,SPACE2=200,XOFFSET=2000,YOFFSET=1500,TFONT=2,TCHARSIZE=100,SPACE3=400
   black=FSC_COLOR("black",2)
   red=FSC_COLOR("red",3)
   blue=FSC_COLOR("blue",4)
   purple=FSC_COLOR("purple",5)
   GSET,XMIN=0,XMAX=n_sets-1,YMIN=REFORM(range_norm(i,0)),YMAX=REFORM(range_norm(i,1)),TITLE=REFORM(titles(i))
   FOR j=1,n_sets-1 DO BEGIN
      this_metric_values=metrics_norm_obs(i*n_sets+j,*)
      this_metric_values=this_metric_values[where(this_metric_values ne missing)]
      this_metric_values=this_metric_values[SORT(this_metric_values)]
      EBAR,X=j-0.5,BOX=[MIN(this_metric_values),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/4)),$
                        this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)/2)),this_metric_values(FLOOR(N_ELEMENTS(this_metric_values)*3/4)),$
                        MAX(this_metric_values)],width=166,COL=colors(j)
      GPLOT,X=indgen(n_sets),Y=REPLICATE(1,n_sets),THICK=150,STYLE=2
      GPLOT,X=indgen(n_sets),Y=REPLICATE(1.25,n_sets),THICK=150,STYLE=1
      GPLOT,X=indgen(n_sets),Y=REPLICATE(0.75,n_sets),THICK=150,STYLE=1
      ;GPLOT,X=indgen(n_sets),Y=REPLICATE((STDDEV(metrics_obs(i,0:obs_nyears-1))+MEAN(metrics_obs(i,0:obs_nyears-1)))/MEAN(metrics_obs(i,0:obs_nyears-1)),n_sets),THICK=1.5,STYLE=1
;      GPLOT,X=indgen(n_sets),Y=REPLICATE((MEAN(metrics_obs(i,0:obs_nyears-1))-STDDEV(metrics_obs(i,0:obs_nyears-1)))/MEAN(metrics_obs(i,0:obs_nyears-1)),n_sets),THICK=1.5,STYLE=1
;      GPLOT,X=indgen(n_sets),Y=REPLICATE((MEAN(metrics_obs(i,0:obs_nyears-1))-STDDEV(metrics_obs(i,0:obs_nyears-1)))/MEAN(metrics_obs(i,0:obs_nyears-1)),n_sets),THICK=1.5,STYLE=1
   ENDFOR
   ystep=range_norm(i,1)/10.
   AXES,XVALS=indgen(n_sets-1)+0.5,XLABELS=xlabels(i*n_sets+1:(i+1)*n_sets-1),YSTEP=ystep(0),$
        XTITLE='Model integration',YTITLE='Ratio: (model_variability/model_mean) / (observed_variability/observed_mean)',NDECS=2
   LEGEND,labels=legend_items,COL=legend_colors,LEGPOS=9
;   device,file=psfile,bits_per_pixel=24;,set_font='Hershey',/color
;   BoxPlot,metrics_norm_obs(i*n_sets+1:(i+1)*n_sets-1,*),labels=xlabels(i*n_sets+1:(i+1)*n_sets-1),missing_data_value=missing,$
;           yrange=REFORM(range_norm(i,*)),ystyle=1,ytitle='Stddev in area-avg, filtered rain for July and Aug scaled by mean',$
;           thick=3,charthick=1.50,xthick=3,ythick=3,rotate=45,charsize=1.20,title=titles(i)
;   oplot,indgen(100)*0.1,REPLICATE(1,100),thick=1.5
;   oplot,indgen(100)*0.1,REPLICATE((stddev(metrics_obs(i,0:obs_nyears-1))+mean(metrics_obs(i,0:obs_nyears-1)))/mean(metrics_obs(i,0:obs_nyears-1)),10;0),thick=1.5,linestyle=1
;   oplot,indgen(100)*0.1,REPLICATE((mean(metrics_obs(i,0:obs_nyears-1))-stddev(metrics_obs(i,0:obs_nyears-1)))/mean(metrics_obs(i,0:obs_nyears-1)),100),thick=1.5,linestyle=1
;   device,/close
   PSCLOSE,/NOVIEW

ENDFOR

                                ; FOR k=0,n_metrics-1 DO BEGIN
;         this_metric=REFORM(metrics(k,*))
;         sorted_metric=this_metric[Sort(this_metric)]
;         IF N_ELEMENTS(sorted_metric) MOD 2 EQ 0 THEN BEGIN
;             index=N_ELEMENTS(sorted_metric)/2
;             medianData=(sorted_metric[index-1]+sorted_metric[index])/2.0
;             lowerGroup=sorted_metric[0:index-1]
;             higherGroup=sorted_metric[index:N_ELEMENTS(sorted_metric)-1]
;         ENDIF ELSE BEGIN
;             index=N_ELEMENTS(sorted_metric)/2
;             medianData=sorted_metric[index]
;             lowerGroup=sorted_metric[0:index-1]
;             higherGroup=sorted_metric[index+1:N_ELEMENTS(sorted_metric)-1]
;         ENDELSE
;         quartile_25=Median(lowerGroup,/EVEN)
;         quartile_75=Median(higherGroup,/EVEN)
;         irq=quartile_75-quartile_25

;         min_metric=MIN(this_metric,MAX=max_metric)
;         halfwidth=width/2.0
;         x1=xlocation-halfwidth
;         x2=xlocation+halfwidth
;         y1=quartile_25
;         y2=quartile_75
;         PLOTS,[x1,x1,x2,x2,x1],[y1,y2,y2,y1,y1]
;         PLOTS,[x1,x2],[medianData,medianData]

;         imax=WHERE(this_metric GT quartile_75 + (1.5*irq),maxcount)
;         IF maxcount EQ 0 THEN BEGIN
;             top=max_metric
;         ENDIF ELSE BEGIN
;             index=Value_Locate(sorted_metric,quartile_75+(1.5*irq))
;             top=sorted_metric[0 > (index) < (N_ELEMENTS(this_metric)-1)]
;         ENDELSE

;         imin=WHERE(this_metric LT quartile_25 - (1.5*irq),mincount)
;         IF mincount EQ 0 THEN BEGIN
;             bottom=min_metric
;         ENDIF ELSE BEGIN
;             index=Value_Locate(sorted_metric,quartile_25-(1.5*irq))
;             bottom=sorted_metric[0 > (index+1) < (N_ELEMENTS(this_metric)-1)]
;         ENDELSE

;         PLOTS,[xlocation,xlocation],[quartile_75,top]
;         PLOTS,[xlocation,xlocation],[quartile_25,bottom]
;         PLOTS, [xlocation - (halfwidth*0.5), xlocation + (halfwidth*0.5)], $
;           [top, top], COLOR=FSC_Color(color)
;         PLOTS, [xlocation - (halfwidth*0.5), xlocation + (halfwidth*0.5)], $
;           [bottom, bottom], COLOR=FSC_Color(color)

;                                 ; Draw outliners if there are any.
;         IF maxcount GT 0 THEN BEGIN
;             FOR m=0,maxcount-1 DO PLOTS, xlocation, this_metric[imax[m]];, $
;                                 ;PSYM=SymCat(9), COLOR=FSC_Color(color)
;         ENDIF
;         IF mincount GT 0 THEN BEGIN
;             FOR m=0,mincount-1 DO PLOTS, xlocation, this_metric[imin[m]];, $
;                                 ;PSYM=SymCat(9), COLOR=FSC_Color(color)
;         ENDIF

;     ENDFOR

STOP

END
